!function(t){function o(o){this.options=t.extend({},l,o),this.__init.call(this)}function e(t,o){var e=t.options.popup_template,n=o.customData;n.Location||(n.Location="");var i=/#\{([^{}]*)}/g;return repr=function(t,o){return"string"==typeof n[o]||"number"==typeof n[o]?n[o]:t},e.replace(i,repr)}function n(o,n){var i=new google.maps.LatLng(n.Latitude,n.Longitude),s=n.Location;"string"!=typeof s&&(s="");var a=new google.maps.Marker({position:i,icon:"//mapka.paczkawruchu.pl/images/blue-dot.png",title:s,customData:n});return google.maps.event.addListener(a,"mouseover",function(){a.setIcon(o.options.marker_icons.mouseover)}),google.maps.event.addListener(a,"mouseout",function(){a.setIcon(o.options.marker_icons.mouseout)}),google.maps.event.addListener(a,"mousedown",function(){a.setIcon(o.options.marker_icons.mousedown)}),google.maps.event.addListener(a,"mouseup",function(){a.setIcon(o.options.marker_icons.mouseup)}),o.options.popup===!1?google.maps.event.addListener(a,"click",function(){o.onselectevent.call(o,this.customData),"inline"!=o.options.inline&&o.hide()}):google.maps.event.addListener(a,"click",function(){o._current_infowindow&&o._current_infowindow.close(),o._current_infowindow=new google.maps.InfoWindow({maxWidth:300}),o.Location||(o.Location="");var n=t(e(o,a));n.find("button").on("click",function(){o.onselectevent.call(o,a.customData),o._current_infowindow.close(),"inline"!=o.options.inline&&o.hide()}),o._current_infowindow.setContent(n[0]),o._current_infowindow.open(o.map,a)}),a.setMap(o.map),a}function s(t,o,e,n){function s(t){return t*Math.PI/180}var a=6371,r=[],p=-1;for(i=0;i<e.length;i++)if(!(n.indexOf(i)>-1)){var c=parseFloat(e[i].Latitude),l=parseFloat(e[i].Longitude),u=s(c-t),h=s(l-o),m=Math.sin(u/2)*Math.sin(u/2)+Math.cos(s(t))*Math.cos(s(t))*Math.sin(h/2)*Math.sin(h/2),d=2*Math.atan2(Math.sqrt(m),Math.sqrt(1-m)),g=a*d;r[i]=g,(-1==p||g<r[p])&&(p=i)}return p}function a(o,e,i,r,p,c){var l=o.options.max_points;(c||""!=t.trim(o.form.street.val()))&&(l=5);var u="ALL";null!==o.options.CashOnDelivery&&(u=1==o.options.CashOnDelivery?"TRUE":"FALSE");var h=o.options.pwr_api_url+"cashondelivery/"+u+"/point/"+o.options.type+"/";1==o.options.filter_by_city&&(h=h+"city/"+e),t.ajax({url:h,cache:!0,accepts:"application/json",contentType:"application/json",crossDomain:!0,dataType:"jsonp",error:function(t,o,e){console.log(t,o,e)},success:function(t){if(console.log(t),!t||t.length<1)return void(1==c?o.showMessage(o.options.locale.no_points):a(o,"ALL",i,r,p,!0));o.clearMarkers();var e,u=[];if(""!=l&&l>0)for(var h,m=[],d=0;l>d;d++)h=s(i,r,t,m),m.push(h),e=n(o,t[h]),u.push(e),o.markers.push(e);else for(var d=0;d<t.length;d++)e=n(o,t[d]),o.markers.push(e),u.push(e);o.fitBounds(u,p)},type:"GET"})}function r(o){var e="";"body"!=o.options.target&&(e="inline");var n={overlay:t('<div class="paczkawruchu_overlay"></div>'),map:t('<div class="paczkawruchu_map_object"></div>'),pwr:t('<div class="paczkawruchu_main '+e+'"></div>'),city:t('<input type="text" class="paczkawruchu_input paczkawruchu_input_city" placeholder="'+o.options.locale.city+'" value="'+(o.options.form.city?o.options.form.city:"")+'" />'),street:t('<input type="text" class="paczkawruchu_input paczkawruchu_input_street" placeholder="'+o.options.locale.street+'" value="'+(o.options.form.street?o.options.form.street:"")+'" />'),searchbtn:t('<button class="paczkawruchu_input paczkawruchu_input_search paczkawruchu_hover_button">'+o.options.locale.searchbtn+"</button>")};if("inline"!=o.options.inline&&(n.closebtn=t('<a class="paczkawruchu_close_btn"></a>')),n.searchbtn.on("click",t.proxy(o.search,o)),"inline"!=o.options.inline&&n.closebtn.on("click",t.proxy(o.hide,o)),1==o.options.autocomplete){var i=(new google.maps.places.Autocomplete(n.city[0],{types:["(cities)"],componentRestrictions:{country:"pl"}}),new google.maps.places.Autocomplete(n.street[0],{types:["address"],componentRestrictions:{country:"pl"}}));google.maps.event.addListener(i,"place_changed",function(){for(var t=i.getPlace(),o=0;o<t.address_components.length;o++)if("route"==t.address_components[o].types[0]){n.street.val(t.address_components[o].long_name);break}})}return n.city.on("keyup",function(e){13==e.keyCode&&(""==t.trim(t(this).val())?(e.preventDefault(),o.showMessage(o.options.locale["bad_form-data"]+" "+o.options.locale.city)):o.search.call(o))}),n.street.on("keyup",function(e){13==e.keyCode&&(""==t.trim(t(this).val())?(e.preventDefault(),o.showMessage(o.options.locale["bad_form-data"]+" "+o.options.locale.street)):o.search.call(o))}),n.pwr.append(n.city),n.pwr.append(n.street),n.pwr.append(n.searchbtn),n.pwr.append(n.closebtn),n.pwr.append(n.map),n}function p(o){var e=o.options.map;e.center&&2==e.center.length&&(e.center=new google.maps.LatLng(e.center[0],e.center[1]));var n=new google.maps.Map(o.form.map[0],e);return google.maps.event.addListener(n,"dragend",t.proxy(o.ondragend,o)),n}var c="pwrgeopicker",l={inline:"popup",target:"body",pwr_api_url:"//mapka.paczkawruchu.pl/g/index.php/points/",filter_by_city:!0,popup_template:'<div style="color:black !important;">#{Location}<br><b>#{StreetName}</b><br><b>Godziny otwarcia: #{OpeningHours}</b><br><br><button class="paczkawruchu_hover_button">Wybierz</button><br><br></div>',popup:!1,max_points:5,onselect:null,autocomplete:!1,type:"ALL",CashOnDelivery:null,auto_start:!1,locale:{city:"Miasto",street:"Ulica",searchbtn:"szukaj &gt;",no_points:"Nie znaleziono punktów","bad_form-data":"Wypełnij poprawnie pole:"},marker_icons:{mouseover:"//mapka.paczkawruchu.pl/images/darkblue-dot.png",mouseout:"//mapka.paczkawruchu.pl/images/blue-dot.png",mousedown:"//mapka.paczkawruchu.pl/images/green-dot.png",mouseup:"//mapka.paczkawruchu.pl/images/blue-dot.png"},form:{city:"",street:""},map:{center:[51.9077298,19.9526048],zoom:7,scrollwheel:!1,navigationControl:!1,mapTypeControl:!1,scaleControl:!1}};o.prototype={__init:function(){this.onselectevent=this.options.onselect?this.options.onselect:function(t){console.log(t)},this._current_infowindow,this.ondragend=function(){},this.markers=[],this._state=!1,this.form=r(this),this.map=null,this.geocoder=new google.maps.Geocoder,"body"!=this.options.target&&this.show()},fitBounds:function(t,o){console.log(t,o);for(var e=new google.maps.LatLngBounds,n=0;n<t.length;n++)e.extend(t[n].position);o||(this.map.setCenter(e.getCenter()),this.map.fitBounds(e))},clearMarkers:function(){if(this.markers.length>0){for(var t=0;t<this.markers.length;t++)this.markers[t].setMap(null);this.markers=[]}},collectFormData:function(){var o=[t.trim(this.form.city.val()),t.trim(this.form.street.val())];return o},show:function(){var o=this;this._state===!1?("body"==this.options.target?(t(this.options.target).append(this.form.overlay),t(this.options.target).append(this.form.pwr)):t(this.options.target).html(this.form.pwr),setTimeout(function(){o.map=p(o)},400),this._state=!0,this.options.auto_start&&this.search()):(this.form.overlay.show(),this.form.pwr.show())},hide:function(){this.form.overlay.hide(),this.form.pwr.hide()},destroy:function(){},updateForm:function(){},search:function(){var o=this.collectFormData();if(""!=o[0]||""!=o[1])return this.geocoder.geocode({address:o.join(",")},t.proxy(function(o,e){if(e==google.maps.GeocoderStatus.OK){o[0].geometry.bounds?this.map.fitBounds(o[0].geometry.bounds):(this.map.setCenter(o[0].geometry.location),this.map.setZoom(16));for(var n=null,i=0;i<o.length&&("undefined"!=o[i].address_components&&t.each(o[i].address_components,function(){return this.types&&-1!=this.types.indexOf("locality")?(n=this.long_name,!1):this.types&&-1!=this.types.indexOf("administrative_area_level_2")?(n=this.long_name,!1):void 0}),!n);i++);if(!n&&1==this.options.filter_by_city)return void this.showMessage(this.options.locale["bad_form-data"]+" "+this.options.locale.city);a(this,n,o[0].geometry.location.lat(),o[0].geometry.location.lng())}},this)),!0;var e=this.options.locale["bad_form-data"];return""==o[0]&&(e=e+" "+this.options.locale.city),""==o[1]&&(e=e+" "+this.options.locale.street),this.showMessage(e),!1},showMessage:function(t){alert(t)},onSelect:function(t){this.onselectevent=t}},t.PwrGeoPicker=function(t){return new o(t)},t.fn[c]=function(e,n){return this.each(function(){t.data(this,"plugin_"+c)||(e||(e="popup"),n||(n={}),n.inline=e,"inline"==e?n.target=this:t(this).on("click",function(){t(this).data("plugin_"+c).show()}),t.data(this,"plugin_"+c,new o(n)))}),this}}(jQuery,window,document);
